<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dahira Kenal - Espace Membre</title>
    <link rel="stylesheet" href="fontawesome/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ecfdf5 0%, #ccfbf1 100%);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: #e5e7eb;
        }

        .header {
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #d1fae5;
        }

        .tabs {
            background: white;
            display: flex;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        body.dark-mode .tabs {
            background: #1f2937;
        }

        .tab {
            flex: 1;
            padding: 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
            white-space: nowrap;
        }

        body.dark-mode .tab {
            color: #9ca3af;
        }

        .tab:hover {
            background: #f3f4f6;
        }

        body.dark-mode .tab:hover {
            background: #374151;
        }

        .tab.active {
            color: white;
            background: #059669;
            border-bottom-color: #047857;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .top-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: #d1d5db;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #9ca3af;
        }

        body.dark-mode .btn-secondary {
            background: #4b5563;
            color: #e5e7eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .metric-card h3 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .metric-card p {
            margin: 0;
        }

        .metric-card div {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .dashboard-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #059669;
        }

        body.dark-mode .kpi-card {
            background: #2d3748;
            color: #e5e7eb;
        }

        .dashboard-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .chart-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        body.dark-mode .chart-card {
            background: #2d3748;
            color: #e5e7eb;
        }

        .chart-card h3 {
            margin-bottom: 1.5rem;
            color: #1f2937;
        }

        body.dark-mode .chart-card h3 {
            color: #e5e7eb;
        }

        .chart-card canvas {
            max-height: 350px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stats-card {
            background: linear-gradient(135deg, #059669 0%, #0d9488 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stats-card h3 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .big-number {
            font-size: 1.75rem;
            font-weight: bold;
            margin: 0;
        }

        .member-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        body.dark-mode .member-card {
            background: #2d3748;
            color: #e5e7eb;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            font-size: 1.2rem;
            color: #059669;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #059669;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .dashboard-metrics {
                grid-template-columns: 1fr;
            }

            .dashboard-charts {
                grid-template-columns: 1fr;
            }

            .tabs {
                overflow-x: auto;
            }

            .tab {
                min-width: 120px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üïå Dahira Kenal - Espace Membre</h1>
        <p>Bienvenue dans votre tableau de bord</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard', event)">üìä Dashboard</button>
        <button class="tab" onclick="showTab('stats', event)">üìà Statistiques</button>
    </div>

    <div class="container">
        <div class="top-buttons">
            <button class="btn-secondary" id="btn-theme" onclick="toggleDarkMode()">üåô Mode Sombre</button>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active">
            <h2 style="margin-bottom: 2rem;">üìä Dashboard - Vue d'ensemble</h2>

            <div class="loading" id="dashboard-loading">
                <div class="spinner"></div>
                Chargement des donn√©es...
            </div>

            <div id="dashboard-content" style="display: none;">
                <!-- M√©triques principales -->
                <div class="dashboard-metrics">
                    <div class="metric-card" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">Total Membres</h3>
                        <p style="font-size: 2rem; font-weight: bold; margin: 0;" id="dashboard-total-membres">0</p>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">
                            <span id="dashboard-nouveaux-membres">0</span> nouveaux ce mois
                        </div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">Cotisations du Mois</h3>
                        <p style="font-size: 2rem; font-weight: bold; margin: 0;" id="dashboard-cotisations-mois">0 FCFA</p>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">
                            <span id="dashboard-cotisations-annee">0</span> FCFA cette ann√©e
                        </div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">D√©penses du Mois</h3>
                        <p style="font-size: 2rem; font-weight: bold; margin: 0;" id="dashboard-depenses-mois">0 FCFA</p>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">
                            <span id="dashboard-ratio-depenses">0</span>% du budget
                        </div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-bottom: 0.5rem; font-size: 0.9rem; opacity: 0.9;">Solde</h3>
                        <p style="font-size: 2rem; font-weight: bold; margin: 0;" id="dashboard-solde">0 FCFA</p>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">
                            <span id="dashboard-solde-trend" style="color: #10b981;">‚ÜóÔ∏è +0%</span> vs mois dernier
                        </div>
                    </div>
                </div>

                <!-- KPIs suppl√©mentaires -->
                <div class="dashboard-kpis">
                    <div class="kpi-card" style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #059669;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Taux des ADIYA</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: #059669; margin: 0;" id="kpi-taux-paiement">0%</p>
                            </div>
                            <div style="font-size: 2rem;">üìä</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #059669;" id="kpi-membres-ajour">0</span> membres √† jour
                        </div>
                    </div>

                    <div class="kpi-card" style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #3b82f6;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Moyenne/Membre</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: #3b82f6; margin: 0;" id="kpi-moyenne-membre">0 FCFA</p>
                            </div>
                            <div style="font-size: 2rem;">üë•</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #3b82f6;">Cotisation moyenne</span>
                        </div>
                    </div>

                    <div class="kpi-card" style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #f59e0b;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Croissance</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: #f59e0b; margin: 0;" id="kpi-croissance">+0%</p>
                            </div>
                            <div style="font-size: 2rem;">üìà</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #f59e0b;">Nouveaux membres</span>
                        </div>
                    </div>

                    <div class="kpi-card" style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #7c3aed;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Activit√©</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: #7c3aed; margin: 0;" id="kpi-activite">0%</p>
                            </div>
                            <div style="font-size: 2rem;">‚ö°</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #7c3aed;">Membres actifs</span>
                        </div>
                    </div>

                    <div class="kpi-card" style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #ec4899;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">√âquilibre</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: #ec4899; margin: 0;" id="kpi-equilibre">0%</p>
                            </div>
                            <div style="font-size: 2rem;">‚öñÔ∏è</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #ec4899;">Ratio D√©p./Rec.</span>
                        </div>
                    </div>

                    <div class="kpi-card" style="background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); border-left: 4px solid #059669;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <p style="font-size: 0.8rem; color: #6b7280; margin: 0;">Performance</p>
                                <p style="font-size: 1.5rem; font-weight: bold; color: #059669; margin: 0;" id="kpi-performance">0%</p>
                            </div>
                            <div style="font-size: 2rem;">üéØ</div>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <span style="font-size: 0.75rem; color: #059669;">Objectif mensuel</span>
                        </div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="dashboard-charts">
                    <div class="chart-card">
                        <h3 style="margin-bottom: 1.5rem; color: #1f2937;">R√©partition par Sexe</h3>
                        <div style="height: 300px;">
                            <canvas id="chart-sexe"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 style="margin-bottom: 1.5rem; color: #1f2937;">√âvolution des Membres</h3>
                        <div style="height: 300px;">
                            <canvas id="chart-evolution"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 style="margin-bottom: 1.5rem; color: #1f2937;">ADIYA par Caisse (Dernier Mois)</h3>
                        <div style="height: 300px;">
                            <canvas id="chart-paiements-caisse"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 style="margin-bottom: 1.5rem; color: #1f2937;">Statut des ADIYA</h3>
                        <div style="height: 300px;">
                            <canvas id="chart-statut-paiements"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 style="margin-bottom: 1.5rem; color: #1f2937;">D√©penses par Caisse (Dernier Mois)</h3>
                        <div style="height: 300px;">
                            <canvas id="chart-depenses-caisse"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3 style="margin-bottom: 1.5rem; color: #1f2937;">Top 5 Contributeurs</h3>
                        <div style="height: 300px;">
                            <canvas id="chart-top-contributeurs"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATS TAB -->
        <div id="tab-stats" class="tab-content">
            <h2 style="margin-bottom: 1.5rem;">üìà Statistiques Globales</h2>

            <div class="loading" id="stats-loading" style="display: none;">
                <div class="spinner"></div>
                Chargement des statistiques...
            </div>

            <div id="stats-content">
                <div class="stats-cards">
                    <div class="stats-card">
                        <h3>Caisse Hebdomadaire</h3>
                        <p class="big-number" id="total-hebdo">0</p>
                        <p style="opacity: 0.8;">FCFA</p>
                        <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: <span id="expense-hebdo">0</span> FCFA</p>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);">
                        <h3>Caisse Mensuelle</h3>
                        <p class="big-number" id="total-mensuel">0</p>
                        <p style="opacity: 0.8;">FCFA</p>
                        <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: <span id="expense-mensuel">0</span> FCFA</p>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <h3>Caisse Sociale</h3>
                        <p class="big-number" id="total-social">0</p>
                        <p style="opacity: 0.8;">FCFA</p>
                        <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: <span id="expense-social">0</span> FCFA</p>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">
                        <h3>Caisse Diayante</h3>
                        <p class="big-number" id="total-diayante">0</p>
                        <p style="opacity: 0.8;">FCFA</p>
                        <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: <span id="expense-diayante">0</span> FCFA</p>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <h3>Total D√©penses</h3>
                        <p class="big-number" id="total-expenses">0</p>
                        <p style="opacity: 0.8;">FCFA</p>
                    </div>
                    <div class="stats-card" style="background: linear-gradient(135deg, #374151 0%, #1f2937 100%);">
                        <h3>Total Global</h3>
                        <p class="big-number" id="total-global">0</p>
                        <p style="opacity: 0.8;">FCFA</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBkcnXxfcw4TN3DSmtUeimJ5br7PuBpqVo",
            authDomain: "dahira-kenal.firebaseapp.com",
            databaseURL: "https://dahira-kenal-default-rtdb.firebaseio.com",
            projectId: "dahira-kenal",
            storageBucket: "dahira-kenal.firebasestorage.app",
            messagingSenderId: "363618938352",
            appId: "1:363618938352:web:307a7e87a9571cf08d4135",
            measurementId: "G-MD6F2PKZZY"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let membres = [];
        let payments = [];
        let expenses = [];
        let charts = {};
        let events = [];

        // Auto-import data on login
        auth.onAuthStateChanged(async user => {
            if (user) {
                try {
                    const ref = db.ref('users/' + user.uid);
                    const snap = await ref.once('value');
                    if (snap.exists()) {
                        const data = snap.val() || {};
                        membres = data.membres || [];
                        payments = data.payments || [];
                        expenses = data.expenses || [];
                        events = data.events || [];
                        updateDashboard();
                        updateStats();
                    }
                } catch (err) {
                    console.error('Auto-import failed:', err);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        function showTab(tabName, event) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (event) event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');

            if (tabName === 'dashboard') {
                document.getElementById('dashboard-loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                setTimeout(() => {
                    Object.values(charts).forEach(chart => {
                        if (chart && typeof chart.resize === 'function') {
                            chart.resize();
                        }
                    });
                }, 100);
            }
        }

        function updateDashboard() {
            const dashboardLoading = document.getElementById('dashboard-loading');
            const dashboardContent = document.getElementById('dashboard-content');

            if (dashboardLoading) dashboardLoading.style.display = 'none';
            if (dashboardContent) dashboardContent.style.display = 'block';

            // Metrics
            document.getElementById('dashboard-total-membres').textContent = membres.length;

            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const newMembersThisMonth = membres.filter(m => {
                const adhDate = new Date(m.dateAdhesion);
                return adhDate.getMonth() === thisMonth && adhDate.getFullYear() === thisYear;
            }).length;
            document.getElementById('dashboard-nouveaux-membres').textContent = newMembersThisMonth;

            const cotisationsThisMonth = payments
                .filter(p => {
                    const payDate = new Date(p.date);
                    return payDate.getMonth() === thisMonth && payDate.getFullYear() === thisYear;
                })
                .reduce((s, p) => s + p.montant, 0);
            document.getElementById('dashboard-cotisations-mois').textContent = cotisationsThisMonth + ' FCFA';

            const cotisationsThisYear = payments
                .filter(p => new Date(p.date).getFullYear() === thisYear)
                .reduce((s, p) => s + p.montant, 0);
            document.getElementById('dashboard-cotisations-annee').textContent = cotisationsThisYear;

            const depensesThisMonth = expenses
                .filter(e => {
                    const expDate = new Date(e.date);
                    return expDate.getMonth() === thisMonth && expDate.getFullYear() === thisYear;
                })
                .reduce((s, e) => s + e.montant, 0);
            document.getElementById('dashboard-depenses-mois').textContent = depensesThisMonth + ' FCFA';

            const ratio = cotisationsThisMonth > 0 ? Math.round((depensesThisMonth / cotisationsThisMonth) * 100) : 0;
            document.getElementById('dashboard-ratio-depenses').textContent = ratio;

            const solde = cotisationsThisMonth - depensesThisMonth;
            document.getElementById('dashboard-solde').textContent = solde + ' FCFA';

            // KPIs
            const tjPublushedhour = Math.round((membres.filter(m => getPaymentStatus(m.id) === '√Ä jour').length / membres.length) * 100) || 0;
            document.getElementById('kpi-taux-paiement').textContent = tjPublushedhour + '%';
            document.getElementById('kpi-membres-ajour').textContent = membres.filter(m => getPaymentStatus(m.id) === '√Ä jour').length;

            const avgPerMember = membres.length > 0 ? Math.round(cotisationsThisMonth / membres.length) : 0;
            document.getElementById('kpi-moyenne-membre').textContent = avgPerMember + ' FCFA';

            const growthPercent = Math.round((newMembersThisMonth / Math.max(membres.length, 1)) * 100);
            document.getElementById('kpi-croissance').textContent = '+' + growthPercent + '%';

            const activeMembers = Math.round((payments.filter(p => new Date(p.date) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)).length / Math.max(payments.length, 1)) * 100) || 0;
            document.getElementById('kpi-activite').textContent = activeMembers + '%';

            const ratio2 = cotisationsThisMonth > 0 ? Math.round((depensesThisMonth / cotisationsThisMonth) * 100) : 0;
            document.getElementById('kpi-equilibre').textContent = ratio2 + '%';

            const targetMonthly = 100000;
            const performancePercent = Math.round((cotisationsThisMonth / targetMonthly) * 100);
            document.getElementById('kpi-performance').textContent = performancePercent + '%';

            renderDashboardCharts();
        }

        function updateStats() {
            const hebdo = payments.filter(p => p.type === 'hebdomadaire').reduce((s, p) => s + p.montant, 0);
            const mensuel = payments.filter(p => p.type === 'mensuelle').reduce((s, p) => s + p.montant, 0);
            const diayante = payments.filter(p => p.type === 'diayante').reduce((s, p) => s + p.montant, 0);
            const social = payments.filter(p => p.type === 'social').reduce((s, p) => s + p.montant, 0);

            const expenseHebdo = expenses.filter(e => e.caisse === 'hebdomadaire').reduce((s, e) => s + e.montant, 0);
            const expenseMensuel = expenses.filter(e => e.caisse === 'mensuelle').reduce((s, e) => s + e.montant, 0);
            const expenseDiayante = expenses.filter(e => e.caisse === 'diayante').reduce((s, e) => s + e.montant, 0);
            const expenseSocial = expenses.filter(e => e.caisse === 'social').reduce((s, e) => s + e.montant, 0);
            const totalExpenses = expenseHebdo + expenseMensuel + expenseDiayante + expenseSocial;

            const netHebdo = hebdo - expenseHebdo;
            const netMensuel = mensuel - expenseMensuel;
            const netSocial = social - expenseSocial;
            const netDiayante = diayante - expenseDiayante;
            const netGlobal = netHebdo + netMensuel + netSocial + netDiayante;

            document.getElementById('total-hebdo').textContent = netHebdo;
            document.getElementById('total-mensuel').textContent = netMensuel;
            document.getElementById('total-social').textContent = netSocial;
            document.getElementById('total-diayante').textContent = netDiayante;
            document.getElementById('total-global').textContent = netGlobal;

            document.getElementById('expense-hebdo').textContent = expenseHebdo;
            document.getElementById('expense-mensuel').textContent = expenseMensuel;
            document.getElementById('expense-social').textContent = expenseSocial;
            document.getElementById('expense-diayante').textContent = expenseDiayante;
            document.getElementById('total-expenses').textContent = totalExpenses;

            // Add event stats cards to stats page
            document.querySelectorAll('.event-stats-card').forEach(card => card.remove());
            if (Array.isArray(events)) {
                events.forEach(evt => {
                    const revenues = payments.filter(p => p.type === evt.caisse).reduce((s, p) => s + p.montant, 0);
                    const expensesEvt = expenses.filter(e => e.caisse === evt.caisse).reduce((s, e) => s + e.montant, 0);
                    const net = revenues - expensesEvt;
                    const card = document.createElement('div');
                    card.className = 'stats-card event-stats-card';
                    card.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                    card.innerHTML = `
                        <h3>${evt.title}</h3>
                        <p class="big-number">${net}</p>
                        <p style="opacity: 0.8;">FCFA</p>
                        <p style="margin-top:0.5rem; font-size:0.9rem; color:#b91c1c;">D√©penses: ${expensesEvt} FCFA</p>
                    `;
                    const statsCardsContainer = document.querySelector('.stats-cards');
                    if (statsCardsContainer) {
                        statsCardsContainer.appendChild(card);
                    }
                });
            }
        }

        function getPaymentStatus(memberId) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentMonthPayments = payments.filter(p => {
                const paymentDate = new Date(p.date);
                return p.memberId === memberId && paymentDate.getMonth() === currentMonth;
            });
            const hebdoTotal = currentMonthPayments.filter(p => p.type === 'hebdomadaire').reduce((sum, p) => sum + p.montant, 0);
            const mensuelTotal = currentMonthPayments.filter(p => p.type === 'mensuelle').reduce((sum, p) => sum + p.montant, 0);
            return (hebdoTotal >= 1000 && mensuelTotal >= 500) ? '√Ä jour' : 'En retard';
        }

        function renderDashboardCharts() {
            const ctx1 = document.getElementById('chart-sexe')?.getContext('2d');
            if (ctx1 && membres) {
                const hommes = membres.filter(m => (m.sexe || 'M') === 'M').length;
                const femmes = membres.filter(m => m.sexe === 'F').length;
                if (charts.sexe) charts.sexe.destroy();
                charts.sexe = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: ['Hommes', 'Femmes'],
                        datasets: [{
                            data: [hommes, femmes],
                            backgroundColor: ['#3b82f6', '#ec4899'],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            }

            const ctx2 = document.getElementById('chart-evolution')?.getContext('2d');
            if (ctx2) {
                const monthData = new Array(12).fill(0);
                const now = new Date();
                membres.forEach(m => {
                    const adhDate = new Date(m.dateAdhesion);
                    if (adhDate.getFullYear() === now.getFullYear()) {
                        monthData[adhDate.getMonth()]++;
                    }
                });
                const cumulative = monthData.map((v, i) => monthData.slice(0, i + 1).reduce((a, b) => a + b, 0));
                if (charts.evolution) charts.evolution.destroy();
                charts.evolution = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'],
                        datasets: [{
                            label: 'Membres Cumulatifs',
                            data: cumulative,
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
                });
            }

            const ctx3 = document.getElementById('chart-paiements-caisse')?.getContext('2d');
            if (ctx3) {
                const hebdoPay = payments.filter(p => p.type === 'hebdomadaire').reduce((s, p) => s + p.montant, 0);
                const mensuelPay = payments.filter(p => p.type === 'mensuelle').reduce((s, p) => s + p.montant, 0);
                const socialPay = payments.filter(p => p.type === 'social').reduce((s, p) => s + p.montant, 0);
                const diayantePay = payments.filter(p => p.type === 'diayante').reduce((s, p) => s + p.montant, 0);
                if (charts.paiementsCaisse) charts.paiementsCaisse.destroy();
                charts.paiementsCaisse = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['Hebdomadaire', 'Mensuelle', 'Sociale', 'Diayante'],
                        datasets: [{
                            label: 'Montant (FCFA)',
                            data: [hebdoPay, mensuelPay, socialPay, diayantePay],
                            backgroundColor: ['#059669', '#0d9488', '#f59e0b', '#7c3aed'],
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
                });
            }

            const ctx4 = document.getElementById('chart-statut-paiements')?.getContext('2d');
            if (ctx4) {
                const onTime = membres.filter(m => getPaymentStatus(m.id) === '√Ä jour').length;
                const late = membres.filter(m => getPaymentStatus(m.id) === 'En retard').length;
                if (charts.statutPaiements) charts.statutPaiements.destroy();
                charts.statutPaiements = new Chart(ctx4, {
                    type: 'doughnut',
                    data: {
                        labels: ['√Ä jour', 'En retard'],
                        datasets: [{
                            data: [onTime, late],
                            backgroundColor: ['#10b981', '#ef4444'],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true }
                });
            }

            const ctx5 = document.getElementById('chart-depenses-caisse')?.getContext('2d');
            if (ctx5) {
                const expHebdo = expenses.filter(e => e.caisse === 'hebdomadaire').reduce((s, e) => s + e.montant, 0);
                const expMensuel = expenses.filter(e => e.caisse === 'mensuelle').reduce((s, e) => s + e.montant, 0);
                const expSocial = expenses.filter(e => e.caisse === 'social').reduce((s, e) => s + e.montant, 0);
                const expDiayante = expenses.filter(e => e.caisse === 'diayante').reduce((s, e) => s + e.montant, 0);
                if (charts.depensesCaisse) charts.depensesCaisse.destroy();
                charts.depensesCaisse = new Chart(ctx5, {
                    type: 'bar',
                    data: {
                        labels: ['Hebdomadaire', 'Mensuelle', 'Sociale', 'Diayante'],
                        datasets: [{
                            label: 'Montant (FCFA)',
                            data: [expHebdo, expMensuel, expSocial, expDiayante],
                            backgroundColor: ['#ef4444', '#dc2626', '#f97316', '#d97706'],
                            borderRadius: 5
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } } }
                });
            }

            const ctx6 = document.getElementById('chart-top-contributeurs')?.getContext('2d');
            if (ctx6) {
                const topMembers = membres.sort((a, b) => {
                    const aTotal = payments.filter(p => p.memberId === a.id).reduce((s, p) => s + p.montant, 0);
                    const bTotal = payments.filter(p => p.memberId === b.id).reduce((s, p) => s + p.montant, 0);
                    return bTotal - aTotal;
                }).slice(0, 5);

                const topData = topMembers.map(m => payments.filter(p => p.memberId === m.id).reduce((s, p) => s + p.montant, 0));
                const topLabels = topMembers.map(m => m.prenom);

                if (charts.topContributeurs) charts.topContributeurs.destroy();
                charts.topContributeurs = new Chart(ctx6, {
                    type: 'bar',
                    data: {
                        labels: topLabels,
                        datasets: [{
                            label: 'Total Cotisations (FCFA)',
                            data: topData,
                            backgroundColor: '#059669',
                            borderRadius: 5
                        }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true, scales: { x: { beginAtZero: true } } }
                });
            }
        }
    </script>
</body>

</html>
